<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Documentation Index</title>
  <meta name="repo-owner" content="" />
  <meta name="repo-name" content="" />
  <meta name="description" content="Documentation site for our project. Explore our Markdown docs with enhanced features." />
  <meta property="og:title" content="Documentation Index" />
  <meta property="og:description" content="Documentation site for our project. Explore our Markdown docs with enhanced features." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://Jay60Dev.github.io/lib/" />
  <link rel="icon" href="https://yourdomain.com/favicon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Base & Reset */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Roboto', sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    .light-theme { background: #f5f5f5; color: #333; }
    #scroll-progress { position: fixed; top: 0; left: 0; height: 4px; background: #ff9800; width: 0%; z-index: 9999; transition: width 0.1s ease-out; }
    #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 4px; opacity: 0; pointer-events: none; transition: opacity 0.3s, transform 0.3s; z-index: 10000; }
    .light-theme #toast { background: rgba(255,255,255,0.9); color: #333; }
    #spinner { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 8px solid rgba(255,255,255,0.2); border-top: 8px solid #ff9800; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; z-index: 9998; }
    @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
    header { background: #2a2a2a; color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 1000; }
    .light-theme header { background: #fff; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    header h1 { font-size: 24px; font-weight: 500; }
    .header-buttons { display: flex; align-items: center; }
    .header-buttons button, .header-buttons a { background: #444; border: none; color: #fff; padding: 8px 14px; margin-left: 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; font-size: 14px; text-decoration: none; }
    .header-buttons button:hover, .header-buttons a:hover { background: #666; }
    .light-theme .header-buttons button, .light-theme .header-buttons a { background: #ddd; color: #333; }
    .light-theme .header-buttons button:hover, .light-theme .header-buttons a:hover { background: #bbb; }
    #main { display: flex; height: calc(100vh - 60px); }
    #sidebar { width: 260px; background: #202020; padding: 20px; border-right: 1px solid #333; overflow-y: auto; transition: width 0.3s, background 0.3s; position: relative; }
    .light-theme #sidebar { background: #fff; border-right: 1px solid #ddd; }
    #sidebar.collapsed { width: 60px; }
    #sidebar input[type="text"] { width: 100%; padding: 8px 12px; margin-bottom: 10px; border: 1px solid #444; border-radius: 4px; font-size: 14px; outline: none; background: #333; color: #e0e0e0; }
    .light-theme #sidebar input[type="text"] { background: #f9f9f9; border: 1px solid #ccc; color: #333; }
    #sidebar-list { margin-top: 10px; }
    .doc-button { width: 100%; background: #444; border: none; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; text-align: left; font-size: 14px; }
    .doc-button:hover, .doc-button.active { background: #666; }
    .light-theme .doc-button { background: #ddd; color: #333; }
    .light-theme .doc-button:hover, .light-theme .doc-button.active { background: #bbb; }
    #content { flex-grow: 1; background: #1a1a1a; padding: 20px; overflow-y: auto; position: relative; transition: background 0.3s; }
    .light-theme #content { background: #fff; }
    .md-content { background: #2a2a2a; padding: 20px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.5); animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .light-theme .md-content { background: #fefefe; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    .md-content details { background: #2a2a2a; border: 1px solid #444; border-radius: 4px; padding: 10px; margin: 20px 0; transition: background 0.3s, border 0.3s; }
    .md-content details summary { font-size: 18px; font-weight: 500; cursor: pointer; padding: 5px; outline: none; color: #e0e0e0; }
    .md-content details[open] summary { border-bottom: 1px solid #444; margin-bottom: 10px; }
    .md-content hr { border: none; border-top: 1px solid #444; margin: 20px 0; }
    .light-theme .md-content details { background: #f9f9f9; border: 1px solid #ccc; }
    .light-theme .md-content details summary { color: #333; }
    .light-theme .md-content hr { border-top: 1px solid #ccc; }
    .copy-btn { position: absolute; top: 10px; right: 10px; background: #444; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; font-size: 12px; }
    .copy-btn:hover { background: #666; }
    .light-theme .copy-btn { background: #ddd; color: #333; }
    .light-theme .copy-btn:hover { background: #bbb; }
    #back-to-top { position: fixed; bottom: 20px; right: 20px; padding: 10px 14px; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer; display: none; transition: background 0.3s; font-size: 14px; z-index: 1000; }
    #back-to-top:hover { background: #555; }
    .light-theme #back-to-top { background: #ddd; color: #333; }
    .light-theme #back-to-top:hover { background: #bbb; }
    table.home-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    table.home-table td { border: 1px solid #444; padding: 10px; vertical-align: top; }
    .light-theme table.home-table td { border: 1px solid #ccc; }
    table.home-table a { font-weight: bold; color: inherit; text-decoration: none; display: block; margin-bottom: 5px; font-size: 16px; }
    table.home-table small { color: #aaa; font-size: 12px; }
    @media (max-width: 768px) {
      #main { flex-direction: column; height: calc(100vh - 60px); }
      #sidebar { width: 100%; border-right: none; border-bottom: 1px solid #444; }
      #sidebar.collapsed { width: 100%; }
      #content { padding: 10px; }
      header { flex-direction: column; align-items: flex-start; }
      header .header-buttons { margin-top: 10px; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Auto-detect repository info from meta tags or URL.
    const metaOwner = document.querySelector('meta[name="repo-owner"]');
    const metaName = document.querySelector('meta[name="repo-name"]');
    const repoOwner = metaOwner && metaOwner.content ? metaOwner.content : window.location.hostname.split('.')[0];
    const repoName = metaName && metaName.content ? metaName.content : window.location.pathname.split('/')[1];
    const docsPath = "documentation";

    let mdFileContents = {};
    let mdFilesList = [];

    let theme = null; // Set initial theme state

    function safeSetItem(key, value) {
      try {
          localStorage.setItem(key, value);
      }
      catch (e) {
          console.warn("localStorage error setting", key, e);
          if (key === "theme") theme = value;
          // Consider other fallback mechanisms for different keys.
      }
    }

    function safeGetItem(key) {
        try {
            return localStorage.getItem(key);
        }
        catch (e) {
            console.warn("localStorage error getting", key, e);
            if (key === "theme" && theme != null) return theme;
            return null; // Or a suitable default value
        }
    }


    function applyStoredTheme() {
      const storedTheme = safeGetItem("theme");
      if (storedTheme === "light") {
        document.body.classList.add("light-theme");
        document.getElementById("toggle-theme").textContent = "Dark Mode";
      }
    }

    async function fetchMarkdownFiles() {
      try {
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${docsPath}`;
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error('Failed to fetch file list from GitHub API');
        const files = await response.json();
        const mdFiles = files.filter(file => file.name.endsWith(".md")).map(file => file.name.replace(".md", ""));
        mdFilesList = mdFiles;
        populateSidebar(mdFiles);
        await fetchAllMarkdown(mdFiles);
        loadLastOpenedFile();
      } catch (error) {
        console.error('Error fetching file list:', error);
        document.getElementById('sidebar-list').innerHTML = 'Error loading files.';
        showToast("Error fetching files.");
      } finally {
        hideSpinner();
      }
    }

    async function fetchAllMarkdown(mdFiles) {
        for (let file of mdFiles) {
            const fileUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/main/${docsPath}/${file}.md`;
            try {
                const response = await fetch(fileUrl);

                if (!response.ok) {
                    let errorMessage = `Failed to load ${file}.md (HTTP Status: ${response.status})`;

                    // Try to get more details from the response body (if possible)
                    try {
                        const errorBody = await response.text(); // Or response.json() if you expect JSON errors
                        errorMessage += ` - Details: ${errorBody}`;
                    } catch (e) {
                        errorMessage += ` - Could not read error details.`;
                    }

                    console.warn(errorMessage);
                    mdFileContents[file] = errorMessage;


                } else {
                    let rawContent = await response.text();

                    // Pre-process the Markdown content to clean up inconsistencies
                    rawContent = rawContent.replace(/---+/g, '---'); // Normalize horizontal rules
                    rawContent = rawContent.replace(/<details><summary markdown="span">\s*(.*?)\s*<\/summary>\s*---/g, '<details><summary markdown="span">$1</summary>'); // Remove redundant --- inside details

                    mdFileContents[file] = rawContent;
                }


            } catch (error) {
                console.error(`Error fetching ${file}.md:`, error);

                // Double-check to make absolutely sure we're storing a string
                let errorMessage = `Error loading ${file}.md: ${error.message}`;
                if (typeof errorMessage !== 'string') {
                    errorMessage = `Error loading ${file}.md: (Unknown error - string conversion failed)`;
                    console.error("Error message is not a string!", error); // Log the original error object
                }

                mdFileContents[file] = errorMessage;
            }
        }
    }

    function populateSidebar(mdFiles) {
      const sidebar = document.getElementById('sidebar-list');
      sidebar.innerHTML = '';
      mdFiles.forEach(file => {
        const button = document.createElement('button');
        button.classList.add('doc-button');
        button.textContent = file;
        button.setAttribute("aria-label", "Open document " + file);
        button.addEventListener('click', function(event) {
          event.preventDefault();
          loadMarkdown(file);
          document.querySelectorAll(".doc-button.active").forEach(el => el.classList.remove("active"));
          button.classList.add("active");
        });
        sidebar.appendChild(button);
      });
    }

    function getExcerpt(file) {
      const content = mdFileContents[file] || "";
      const plainText = content.replace(/[#>*_`~\-]/g, "").trim();
      return plainText.length > 150 ? plainText.substring(0, 150) + "..." : plainText;
    }

    function sanitizeHTML(html) {
        // Basic sanitization to remove potentially harmful tags and attributes
        // This is just a basic example, you might need a more sophisticated solution
        return html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                   .replace(/onload=|onerror=/gi, '');
    }

    function loadMarkdown(file) {
        safeSetItem("lastOpened", file);
        let rawContent = mdFileContents[file];

        console.log("loadMarkdown: file =", file);
        console.log("loadMarkdown: rawContent (initial) =", rawContent);

        if (typeof rawContent !== "string") {
            console.warn("loadMarkdown: rawContent is NOT a string.  Attempting to convert.");
            try {
                rawContent = JSON.stringify(rawContent, null, 2);
                console.log("loadMarkdown: rawContent (after JSON.stringify) =", rawContent);
            } catch (e) {
                console.error("loadMarkdown: JSON.stringify failed:", e);
                rawContent = "" + rawContent;
                console.log("loadMarkdown: rawContent (after toString) =", rawContent);
            }
        } else {
            console.log("loadMarkdown: rawContent is a string.");
        }

        console.log("loadMarkdown: rawContent (before marked.parse) =", rawContent);

        let content = marked.parse(rawContent || "File not found");

        console.log("loadMarkdown: content (after marked.parse) =", content);

        document.getElementById('content').innerHTML = `<div class="md-content">${content}</div>`;
    }

    function loadHomePage() {
      safeSetItem("lastOpened", "");
      let homeContent = `<div class="md-content"><h1>Welcome</h1><p>Select a document below:</p>`;
      if (mdFilesList.length > 0) {
        const numFiles = Math.min(6, mdFilesList.length);
        let filesCopy = [...mdFilesList];
        filesCopy.sort(() => 0.5 - Math.random());
        const selected = filesCopy.slice(0, numFiles);
        homeContent += "<table class='home-table'><tr>";
        selected.forEach((file, index) => {
          const excerpt = getExcerpt(file);
          homeContent += `<td>
                            <a href="#" onclick="loadMarkdown('${file}'); return false;">${file}</a>
                            <small>${excerpt}</small>
                          </td>`;
          if ((index + 1) % 3 === 0 && index !== selected.length - 1) {
            homeContent += "</tr><tr>";
          }
        });
        homeContent += "</tr></table>";
      } else {
        homeContent += "<p>No documents available.</p>";
      }
      homeContent += "</div>";
      document.getElementById('content').innerHTML = homeContent;
      document.querySelectorAll(".doc-button.active").forEach(el => el.classList.remove("active"));
    }

    function loadLastOpenedFile() {
      const lastFile = safeGetItem("lastOpened");
      if (lastFile && mdFilesList.includes(lastFile) && mdFileContents[lastFile]) {
        loadMarkdown(lastFile);
      } else {
        loadHomePage();
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      sidebar.classList.toggle("collapsed");
      const toggleButton = document.getElementById("toggle-sidebar");
      toggleButton.innerHTML = sidebar.classList.contains("collapsed") ? "☰" : "☰ Toggle Sidebar";
      const homeButton = document.getElementById("home-button");
      if (sidebar.classList.contains("collapsed")) {
        if (!homeButton.dataset.originalText) homeButton.dataset.originalText = homeButton.textContent;
        const letter = homeButton.dataset.originalText.trim()[0].toUpperCase();
        homeButton.innerHTML = `<span style="font-size: 18px;">${letter}</span>`;
      } else {
        if (homeButton.dataset.originalText) homeButton.textContent = homeButton.dataset.originalText;
      }
      document.querySelectorAll(".doc-button").forEach(button => {
        if (sidebar.classList.contains("collapsed")) {
          if (!button.dataset.originalText) button.dataset.originalText = button.textContent;
          const letter = button.dataset.originalText.trim()[0].toUpperCase();
          button.innerHTML = `<span style="font-size: 18px;">${letter}</span>`;
        } else {
          if (button.dataset.originalText) button.textContent = button.dataset.originalText;
        }
      });
    }

    function toggleTheme() {
      document.body.classList.toggle("light-theme");
      const themeButton = document.getElementById("toggle-theme");
      const newTheme = document.body.classList.contains("light-theme") ? "light" : "dark";
      themeButton.textContent = newTheme === "light" ? "Dark Mode" : "Light Mode";
      safeSetItem("theme", newTheme);
    }

    const debounce = (func, delay) => {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          func(...args);
        }, delay);
      };
    };

    function filterDocs() {
      const query = document.getElementById("search-bar").value.toLowerCase();
      document.querySelectorAll(".doc-button").forEach(button => {
        const text = button.dataset.originalText || button.textContent;
        button.style.display = text.toLowerCase().includes(query) ? "block" : "none";
      });
    }

    function updateScrollProgress() {
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const progress = (scrollTop / scrollHeight) * 100;
      document.getElementById("scroll-progress").style.width = progress + "%";
    }

    window.addEventListener("scroll", updateScrollProgress);

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.style.opacity = "1";
      setTimeout(() => { toast.style.opacity = "0"; }, 3000);
    }

    function showSpinner() { document.getElementById("spinner").style.display = "block"; }
    function hideSpinner() { document.getElementById("spinner").style.display = "none"; }

    window.onload = function() {
      applyStoredTheme();
      showSpinner();
      fetchMarkdownFiles();
      document.getElementById("github-link").href = "https://github.com/" + repoOwner + "/" + repoName;
    }
  </script>
</head>
<body>
  <div id="scroll-progress"></div>
  <div id="toast"></div>
  <div id="spinner"></div>
  <header>
    <h1>Documentation Index</h1>
    <div class="header-buttons">
      <button id="toggle-theme" onclick="toggleTheme()">Dark Mode</button>
      <button id="home-button" onclick="loadHomePage()">Home</button>
      <button id="toggle-sidebar" onclick="toggleSidebar()">☰ Toggle Sidebar</button>
      <a id="github-link" href="#" target="_blank" rel="noopener noreferrer">View on GitHub</a>
    </div>
  </header>
  <div id="main">
    <div id="sidebar">
      <input type="text" id="search-bar" oninput="debounce(filterDocs, 300)()" placeholder="Search in documents..." />
      <div id="sidebar-list">Loading...</div>
    </div>
    <div id="content">
      <h2>Select a document from the sidebar</h2>
    </div>
  </div>
  <button id="back-to-top" onclick="updateScrollProgress()">⬆ Back to Top</button>
</body>
</html>
